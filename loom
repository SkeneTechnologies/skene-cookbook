#!/usr/bin/env python3
"""
SKILL-LOOM Enhanced CLI
Interactive terminal with deduplication, chaining, and health analysis
"""

import json
import os
import subprocess
import sys
from pathlib import Path

import yaml

try:
    import pyfiglet
    from rich import box
    from rich.console import Console
    from rich.panel import Panel
    from rich.progress import Progress
    from rich.prompt import Confirm, Prompt
    from rich.table import Table
    from rich.tree import Tree
except ImportError:
    print("‚ùå Missing dependencies. Install with:")
    print("   pip3 install rich pyfiglet")
    sys.exit(1)


console = Console()


def show_banner():
    """Display CLI banner"""
    banner = pyfiglet.figlet_format("SKILL-LOOM", font="slant")
    console.print(f"[bold cyan]{banner}[/bold cyan]")
    console.print("[dim]Enhanced CLI ‚Ä¢ Dedupe ‚Ä¢ Chain ‚Ä¢ Health[/dim]\n")


def cmd_dedupe():
    """Run deduplication analysis"""
    console.clear()
    show_banner()

    console.print("[bold cyan]üîÑ Running Deduplication Analysis...[/bold cyan]\n")

    # Check if dedupe report exists
    report_path = Path("reports/dedupe_report.json")

    if not report_path.exists():
        console.print("[yellow]No existing dedupe report. Running analysis...[/yellow]\n")

        # Run deduplication
        with console.status("[bold green]Analyzing 808 skills..."):
            result = subprocess.run(
                ["python3", "scripts/dedupe_skills.py"], capture_output=True, text=True
            )

        if result.returncode != 0:
            console.print("[red]‚ùå Deduplication failed![/red]")
            console.print(result.stderr)
            return

    # Load report
    with open(report_path, "r") as f:
        report = json.load(f)

    summary = report["summary"]

    # Display summary
    table = Table(title="Deduplication Results", box=box.HEAVY_HEAD)
    table.add_column("Category", style="bold")
    table.add_column("Count", justify="right", style="cyan")
    table.add_column("Action", style="yellow")

    table.add_row("üî¥ Duplicate Groups", str(summary["duplicate_groups"]), "DELETE")
    table.add_row("üü° Similar Pairs", str(summary["similar_pairs"]), "MERGE/REVIEW")
    table.add_row("‚ö†Ô∏è  Incomplete Skills", str(summary["incomplete_skills"]), "FIX")
    table.add_row("‚úÖ Unique & Verified", str(summary["unique_verified_skills"]), "PROMOTE")

    console.print(table)

    console.print(f"\nüí° [bold]Actions Recommended:[/bold]")
    console.print(f"   ‚Ä¢ Delete {summary['deletion_candidates']} duplicate skills")
    console.print(f"   ‚Ä¢ Merge {summary['merge_candidates']} similar pairs")
    console.print(f"   ‚Ä¢ Review {summary['review_candidates']} borderline cases")
    console.print(f"   ‚Ä¢ Fix {summary['incomplete_skills']} incomplete skills")

    console.print(f"\nüìÑ [bold]Full Report:[/bold] reports/dedupe_summary.md")

    # Ask if user wants to see details
    if Confirm.ask("\n[cyan]View duplicate details?[/cyan]", default=False):
        if report["duplicates"]["groups"]:
            console.print("\n[bold]Duplicate Groups:[/bold]\n")
            for i, group in enumerate(report["duplicates"]["groups"][:5], 1):
                console.print(f"{i}. [bold]{group['primary']['skill_id']}[/bold]")
                for dup in group["duplicates"]:
                    console.print(
                        f"   ‚Üí {dup['skill']['skill_id']} (similarity: {dup['similarity']:.3f})"
                    )
                console.print()

    console.print()
    Prompt.ask("[cyan]Press Enter to continue[/cyan]")


def cmd_suggest_chain(job_name=None):
    """Suggest skill chain for a job"""
    console.clear()
    show_banner()

    console.print("[bold cyan]üîó Skill Chain Suggestion[/bold cyan]\n")

    if not job_name:
        console.print("[bold]Available job functions:[/bold]")
        console.print("  ‚Ä¢ engineering")
        console.print("  ‚Ä¢ marketing")
        console.print("  ‚Ä¢ sales")
        console.print("  ‚Ä¢ customer_success")
        console.print("  ‚Ä¢ data\n")

        job_name = Prompt.ask("[cyan]Enter job name[/cyan]")

    # Check if blueprint exists
    blueprint_path = Path(f"registry/blueprints/{job_name}_workflow.yaml")

    if not blueprint_path.exists():
        console.print(f"[yellow]No blueprint found for '{job_name}'[/yellow]")
        console.print("\nGenerating suggestion based on available skills...")

        # Load skills for this function
        with open("registry/job_functions/index.json", "r") as f:
            job_functions = json.load(f)

        if job_name not in job_functions:
            console.print(f"[red]Job function '{job_name}' not found![/red]")
            return

        skills = job_functions[job_name][:10]

        # Generate ASCII chain
        console.print(f"\n[bold]Suggested Chain for {job_name.title()}:[/bold]\n")

        tree = Tree(f"[bold cyan]{job_name.title()} Workflow[/bold cyan]")

        for i, skill in enumerate(skills[:5], 1):
            branch = tree.add(f"[bold]Step {i}:[/bold] {skill['skill_id']}")
            branch.add(f"[dim]{skill['jtbd'][:60]}...[/dim]")

        console.print(tree)

    else:
        # Load existing blueprint
        with open(blueprint_path, "r") as f:
            blueprint = yaml.safe_load(f)

        console.print(
            Panel(
                f"[bold]{blueprint['name']}[/bold]\n\n{blueprint['description']}",
                title="[cyan]Workflow Blueprint[/cyan]",
                border_style="cyan",
            )
        )

        console.print("\n[bold]Chain Sequence:[/bold]\n")

        # ASCII diagram
        steps = blueprint["chain_sequence"]
        for i, step in enumerate(steps, 1):
            console.print(f"  [bold cyan]Step {i}:[/bold cyan] {step['skill_id']}")
            console.print(f"     [dim]‚Üì {step.get('description', '')}[/dim]")

            if i < len(steps):
                console.print("     [dim]‚îÇ[/dim]")

        console.print(f"\n‚úÖ Total Steps: {len(steps)}")

    console.print()
    Prompt.ask("[cyan]Press Enter to continue[/cyan]")


def cmd_health():
    """Show registry health metrics"""
    console.clear()
    show_banner()

    console.print("[bold cyan]üè• Registry Health Check[/bold cyan]\n")

    with Progress() as progress:
        task = progress.add_task("[cyan]Analyzing registry...", total=100)

        # Load skills
        with open("registry/job_functions/index.json", "r") as f:
            job_functions = json.load(f)
        progress.update(task, advance=30)

        # Count skills
        total_skills = sum(len(skills) for skills in job_functions.values())
        progress.update(task, advance=20)

        # Load dedupe report if exists
        dedupe_path = Path("reports/dedupe_report.json")
        unique_skills = 0
        if dedupe_path.exists():
            with open(dedupe_path, "r") as f:
                dedupe_report = json.load(f)
                unique_skills = dedupe_report["summary"]["unique_verified_skills"]
        progress.update(task, advance=30)

        # Load chain analysis if exists
        chain_path = Path("reports/chain_analysis.json")
        chainable = 0
        if chain_path.exists():
            with open(chain_path, "r") as f:
                chain_report = json.load(f)
                chainable = chain_report["summary"].get("chainable_patterns", 0)
        progress.update(task, advance=20)

    # Calculate health metrics
    uniqueness_pct = (unique_skills / total_skills * 100) if total_skills and unique_skills else 0
    chainability_pct = (
        (chainable / total_skills * 100) if total_skills and chainable else 40.0
    )  # Estimate
    verified_pct = 100 - (808 / total_skills * 100)  # Based on incomplete count

    overall_health = (uniqueness_pct + chainability_pct + verified_pct) / 3

    # Display health dashboard
    health_table = Table(title="Registry Health Metrics", box=box.DOUBLE)
    health_table.add_column("Metric", style="bold")
    health_table.add_column("Score", justify="right", style="cyan")
    health_table.add_column("Status", style="green")

    # Uniqueness
    uniqueness_status = "‚úÖ Excellent" if uniqueness_pct > 90 else "‚ö†Ô∏è  Needs work"
    health_table.add_row("Uniqueness", f"{uniqueness_pct:.1f}%", uniqueness_status)

    # Verification
    verified_status = "‚úÖ Good" if verified_pct > 50 else "‚ö†Ô∏è  Needs work"
    health_table.add_row("Verified", f"{verified_pct:.1f}%", verified_status)

    # Chainability
    chainability_status = "‚úÖ Good" if chainability_pct > 30 else "‚ö†Ô∏è  Needs work"
    health_table.add_row("Chainable", f"{chainability_pct:.1f}%", chainability_status)

    # Overall
    overall_status = "‚úÖ Healthy" if overall_health > 50 else "‚ö†Ô∏è  Needs attention"
    health_table.add_row(
        "[bold]Overall Health[/bold]",
        f"[bold]{overall_health:.1f}%[/bold]",
        f"[bold]{overall_status}[/bold]",
    )

    console.print(health_table)

    # Additional stats
    console.print(f"\nüìä [bold]Additional Statistics:[/bold]")
    console.print(f"   ‚Ä¢ Total Skills: {total_skills}")
    console.print(f"   ‚Ä¢ Job Functions: {len(job_functions)}")
    console.print(f"   ‚Ä¢ Blueprints: {len(list(Path('registry/blueprints').glob('*.yaml')))}")

    # Recommendations
    console.print(f"\nüí° [bold]Recommendations:[/bold]")
    if uniqueness_pct < 90:
        console.print("   üîÑ Run deduplication: `loom dedupe`")
    if verified_pct < 50:
        console.print("   üìù Add I/O schemas to skills")
    if chainability_pct < 30:
        console.print("   üîó Generate more blueprints: `python3 scripts/generate_blueprints.py`")

    console.print()
    Prompt.ask("[cyan]Press Enter to continue[/cyan]")


def show_help():
    """Show help message"""
    console.print("\n[bold cyan]SKILL-LOOM CLI[/bold cyan]\n")
    console.print("Usage: loom <command> [args]\n")
    console.print("[bold]Commands:[/bold]")
    console.print("  [cyan]dedupe[/cyan]              Run deduplication analysis")
    console.print("  [cyan]suggest-chain[/cyan] [job] Suggest skill chain for a job")
    console.print("  [cyan]health[/cyan]              Show registry health metrics")
    console.print("  [cyan]interactive[/cyan]         Launch interactive CLI")
    console.print("  [cyan]help[/cyan]                Show this help message\n")

    console.print("[bold]Examples:[/bold]")
    console.print("  loom dedupe")
    console.print("  loom suggest-chain marketing")
    console.print("  loom health")
    console.print("  loom interactive\n")


def main():
    """Main CLI entry point"""
    if len(sys.argv) < 2:
        # Launch interactive mode
        os.system("python3 skill-loom-cli.py")
        return

    command = sys.argv[1]

    if command == "dedupe":
        cmd_dedupe()
    elif command == "suggest-chain":
        job_name = sys.argv[2] if len(sys.argv) > 2 else None
        cmd_suggest_chain(job_name)
    elif command == "health":
        cmd_health()
    elif command == "interactive":
        os.system("python3 skill-loom-cli.py")
    elif command == "help" or command == "--help" or command == "-h":
        show_help()
    else:
        console.print(f"[red]Unknown command: {command}[/red]")
        show_help()
        sys.exit(1)


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        console.print("\n\n[bold yellow]‚ö† Interrupted by user[/bold yellow]")
        sys.exit(0)
    except Exception as e:
        console.print(f"\n[bold red]‚ùå Error: {e}[/bold red]")
        sys.exit(1)
